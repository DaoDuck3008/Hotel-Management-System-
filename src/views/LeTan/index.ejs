<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lễ tân</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background: #f5f7fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .room-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        padding: 20px;
      }

      .room-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .room-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      .room-card.empty {
        border-left: 5px solid #10b981;
      }

      .room-card.occupied {
        border-left: 5px solid #ef4444;
      }

      .room-card.cleaning {
        border-left: 5px solid #f59e0b;
      }

      .room-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #e5e7eb;
      }

      .room-content {
        padding: 20px;
      }

      .room-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .room-number {
        font-size: 20px;
        font-weight: bold;
        color: #1f2937;
      }

      .room-name {
        font-size: 16px;
        color: #374151;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .room-type {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .room-details {
        display: flex;
        gap: 15px;
        margin-bottom: 12px;
        font-size: 13px;
        color: #6b7280;
      }

      .room-detail-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .room-price {
        background: #f3f4f6;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .price-item {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-bottom: 5px;
      }

      .price-item:last-child {
        margin-bottom: 0;
      }

      .price-label {
        color: #6b7280;
      }

      .price-value {
        font-weight: 600;
        color: #1f2937;
      }

      .status-badge {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 15px;
      }

      .status-badge.empty {
        background: #d1fae5;
        color: #065f46;
      }

      .status-badge.occupied {
        background: #fee2e2;
        color: #991b1b;
      }

      .status-badge.cleaning {
        background: #fef3c7;
        color: #92400e;
      }

      .status-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .status-btn {
        flex: 1;
        min-width: 90px;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .status-btn:hover {
        transform: scale(1.05);
      }

      .btn-empty {
        background: #10b981;
        color: white;
      }

      .btn-occupied {
        background: #ef4444;
        color: white;
      }

      .btn-cleaning {
        background: #f59e0b;
        color: white;
      }

      .stats-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stats-number {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stats-label {
        color: #6b7280;
        font-size: 14px;
      }

      .header {
        background: white;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .filter-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .no-image {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 48px;
      }
    </style>
  </head>
  <body>
    <!-- Thông báo -->
    <div
      class="d-flex justify-content-end pt-1 pe-1"
      style="position: fixed; right: 0; top: 0; z-index: 1000"
    >
      <%- include('../partials/notification.ejs') %>
    </div>

    <!-- Header -->
    <div class="header">
      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="h3 mb-0">Lễ tân</h1>
          </div>
          <div class="d-flex gap-3">
            <a href="/receptions/payment" class="btn btn-outline-primary">
              <i class="fas fa-bed me-2"></i>
              Thanh toán phòng
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <!-- Thống kê -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stats-card">
            <div class="stats-number text-primary"><%= stats.total %></div>
            <div class="stats-label">Tổng số phòng</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <div class="stats-number text-success"><%= stats.empty %></div>
            <div class="stats-label">Phòng trống</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <div class="stats-number text-danger"><%= stats.occupied %></div>
            <div class="stats-label">Đang sử dụng</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <div class="stats-number text-warning"><%= stats.cleaning %></div>
            <div class="stats-label">Đang dọn</div>
          </div>
        </div>
      </div>

      <!-- Bộ lọc -->
      <div class="filter-section">
        <div class="row align-items-end">
          <div class="col-md-4">
            <label class="form-label">Tìm kiếm phòng</label>
            <input
              type="text"
              class="form-control"
              id="searchInput"
              placeholder="Nhập mã phòng hoặc tên..."
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Lọc theo trạng thái</label>
            <select class="form-select" id="statusFilter">
              <option value="">Tất cả</option>
              <option value="Empty">Trống</option>
              <option value="Occupied">Đang sử dụng</option>
              <option value="Cleaning">Đang dọn</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Lọc theo loại phòng</label>
            <select class="form-select" id="typeFilter">
              <option value="">Tất cả</option>
              <% const types = [...new Set(rooms.map(r =>
              r.LoaiPhong.TenLoaiPhong))]; %> <% types.forEach(type => { %>
              <option value="<%= type %>"><%= type %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" onclick="resetFilters()">
              <i class="fas fa-redo me-2"></i>Đặt lại
            </button>
          </div>
        </div>
      </div>

      <!-- Danh sách phòng -->
      <div class="room-grid" id="roomGrid">
        <% rooms.forEach(room => { 
          const status = room.getCurrentTrangThai();
          const statusClass = status.toLowerCase(); 
          const statusText = status === 'Empty' ? 'Trống' : status === 'Occupied' ? 'Đang sử dụng' : 'Đang dọn';
          const firstImage = room.HinhAnh && room.HinhAnh.length > 0 ? room.HinhAnh[0].ImgURL : null;
        %>
        <div
          class="room-card <%= statusClass %>"
          data-room="<%= room.MaPhong %>"
          data-status="<%= status %>"
          data-type="<%= room.LoaiPhong.TenLoaiPhong %>"
          data-name="<%= room.TenPhong %>"
        >
          <!-- Hình ảnh phòng -->
          <% if (firstImage) { %>
            <img src="<%= firstImage %>" alt="<%= room.TenPhong %>" class="room-image" />
          <% } else { %>
            <div class="no-image">
              <i class="fas fa-door-open"></i>
            </div>
          <% } %>

          <!-- Nội dung phòng -->
          <div class="room-content">
            <div class="room-header">
              <div class="room-number">
                <i class="fas fa-door-open me-2"></i><%= room.MaPhong %>
              </div>
              <div class="status-badge <%= statusClass %>"><%= statusText %></div>
            </div>

            <div class="room-name"><%= room.TenPhong %></div>
            <div class="room-type"><%= room.LoaiPhong.TenLoaiPhong %></div>

            <!-- Chi tiết phòng -->
            <div class="room-details">
              <div class="room-detail-item">
                <i class="fas fa-bed"></i>
                <span><%= room.SoGiuong %> giường</span>
              </div>
              <div class="room-detail-item">
                <i class="fas fa-users"></i>
                <span><%= room.SucChua %> người</span>
              </div>
            </div>
          <!-- Giá phòng -->
          <div class="room-price">
            <div class="price-item">
              <span class="price-label">Giá theo ngày:</span>
              <span class="price-value"><%= room.getGiaNgayToday().toLocaleString('vi-VN') %> VNĐ</span>
            </div>
            <div class="price-item">
              <span class="price-label">Giá theo giờ:</span>
              <span class="price-value"><%= room.getGiaGioToday().toLocaleString('vi-VN') %> VNĐ</span>
            </div>
          </div>

            <!-- Cập nhật trạng thái -->
            <div class="status-buttons">
              <button
                class="status-btn btn-empty"
                onclick="updateStatus('<%= room.MaPhong %>', 'Empty')"
                <%= status === 'Empty' ? 'disabled style="opacity: 0.5"' : '' %>
              >
                <i class="fas fa-check-circle me-1"></i>Trống
              </button>
              <button
                class="status-btn btn-occupied"
                onclick="updateStatus('<%= room.MaPhong %>', 'Occupied')"
                <%= status === 'Occupied' ? 'disabled style="opacity: 0.5"' : '' %>
              >
                <i class="fas fa-user me-1"></i>Đang dùng
              </button>
              <button
                class="status-btn btn-cleaning"
                onclick="updateStatus('<%= room.MaPhong %>', 'Cleaning')"
                <%= status === 'Cleaning' ? 'disabled style="opacity: 0.5"' : '' %>
              >
                <i class="fas fa-broom me-1"></i>Đang dọn
              </button>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Cập nhật trạng thái phòng
      async function updateStatus(maPhong, status) {
        if (!confirm(`Xác nhận cập nhật trạng thái phòng ${maPhong}?`)) {
          return;
        }

        try {
          const response = await fetch(`/receptions/update-status/${maPhong}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ status }),
          });

          const data = await response.json();

          if (data.success) {
            location.reload();
          } else {
            alert(data.message || "Có lỗi xảy ra");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Có lỗi xảy ra khi cập nhật trạng thái");
        }
      }

      // Bộ lọc
      function filterRooms() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter").value;
        const typeFilter = document.getElementById("typeFilter").value;

        const cards = document.querySelectorAll(".room-card");

        cards.forEach((card) => {
          const roomNumber = card.dataset.room.toLowerCase();
          const roomName = card.dataset.name.toLowerCase();
          const status = card.dataset.status;
          const type = card.dataset.type;

          const matchSearch = !searchTerm || 
            roomNumber.includes(searchTerm) || 
            roomName.includes(searchTerm);
          const matchStatus = !statusFilter || status === statusFilter;
          const matchType = !typeFilter || type === typeFilter;

          if (matchSearch && matchStatus && matchType) {
            card.style.display = "block";
          } else {
            card.style.display = "none";
          }
        });
      }

      function resetFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("typeFilter").value = "";
        filterRooms();
      }

      // Event listeners
      document
        .getElementById("searchInput")
        .addEventListener("input", filterRooms);
      document
        .getElementById("statusFilter")
        .addEventListener("change", filterRooms);
      document
        .getElementById("typeFilter")
        .addEventListener("change", filterRooms);
    </script>
  </body>
</html>