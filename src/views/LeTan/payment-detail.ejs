<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh toán - Đơn #<%= booking.MaDatPhong %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .screen {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        margin-bottom: 20px;
      }
      .screen-title {
        background: #0d6efd;
        color: white;
        padding: 15px 20px;
        font-weight: 600;
      }
      .screen-content {
        padding: 25px;
      }
      .invoice-header {
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 25px;
      }
      .invoice-title {
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 5px;
      }
      .room-section {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        background: #f9fafb;
      }
      .room-section-header {
        background: #2563eb;
        color: white;
        padding: 10px 15px;
        margin: -15px -15px 15px -15px;
        border-radius: 6px 6px 0 0;
        font-weight: 600;
      }
      .payment-method label {
        cursor: pointer;
        transition: all 0.2s;
      }
      .payment-method input[type="radio"]:checked + .form-check-label {
        color: #0d6efd;
        font-weight: 600;
      }
      .total-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-top: 3px solid #0d6efd;
      }
      .total-amount {
        font-size: 28px;
        font-weight: 700;
        color: #0d6efd;
      }
      .table th {
        background-color: #f8f9fa;
        font-weight: 600;
      }
      .table-sm td,
      .table-sm th {
        padding: 8px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="screen">
        <div
          class="screen-title d-flex justify-content-between align-items-center"
        >
          <span>Thanh toán đơn #<%= booking.MaDatPhong %></span>
          <a href="/receptions/payment" class="btn btn-sm btn-light">
            <i class="fas fa-arrow-left me-2"></i>Quay lại
          </a>
        </div>
        <div class="screen-content">
          <div class="row">
            <!-- Hóa đơn -->
            <div class="col-md-7">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="invoice-header">
                    <div class="invoice-title">HÓA ĐƠN THANH TOÁN</div>
                    <div class="text-muted">Đơn #<%= booking.MaDatPhong %></div>
                  </div>

                  <div class="mb-4">
                    <h5 class="mb-3">Thông tin khách hàng</h5>
                    <div class="row">
                      <div class="col-12 mb-2">
                        <strong>Tên:</strong> <%= booking.KhachHang.HoVaTen %>
                      </div>
                      <div class="col-12 mb-2">
                        <strong>SĐT:</strong> <%= booking.KhachHang.SDT %>
                      </div>
                      <div class="col-12">
                        <strong>Email:</strong> <%= booking.KhachHang.Email %>
                      </div>
                    </div>
                  </div>

                  <div class="mb-4">
                    <h5 class="mb-3">Thông tin đặt phòng</h5>
                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <strong>Số phòng:</strong> <%= allRoomsDetails.length %>
                        phòng
                      </div>
                      <div class="col-md-6 mb-2">
                        <strong>Thời gian:</strong>
                        <% if (totalHours <= 6) { %> <%= totalHours %> giờ <% }
                        else { %> <%= totalDays %> ngày <% } %>
                      </div>
                      <div class="col-md-6 mb-2">
                        <strong>Nhận phòng:</strong> <%= new
                        Date(booking.NgayNhanPhong).toLocaleString('vi-VN') %>
                      </div>
                      <div class="col-md-6">
                        <strong>Trả phòng:</strong> <%= new
                        Date(booking.NgayTraPhong).toLocaleString('vi-VN') %>
                      </div>
                    </div>
                  </div>

                  <!-- Chi tiết từng phòng -->
                  <h5 class="mb-3">Chi tiết thanh toán</h5>

                  <% allRoomsDetails.forEach((roomDetail, index) => { %>
                  <div class="room-section">
                    <div class="room-section-header">
                      <i class="fas fa-door-open me-2"></i>
                      Phòng <%= roomDetail.room.MaPhong %> - <%=
                      roomDetail.room.TenPhong %>
                    </div>

                    <div class="mb-2">
                      <small class="text-muted">
                        <%= roomDetail.room.LoaiPhong.TenLoaiPhong %>
                      </small>
                    </div>

                    <table class="table table-sm table-bordered mb-2">
                      <thead>
                        <tr>
                          <th style="width: 25%">Ngày/Giờ</th>
                          <th style="width: 30%">Mô tả</th>
                          <th style="width: 20%">Đơn giá</th>
                          <th style="width: 10%">SL</th>
                          <th style="width: 25%">Thành tiền</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% roomDetail.priceDetails.forEach(detail => { %>
                        <tr>
                          <td><%= detail.date || 'Theo giờ' %></td>
                          <td><small><%= detail.description %></small></td>
                          <td><%= detail.price.toLocaleString('vi-VN') %>đ</td>
                          <td><%= detail.quantity %></td>
                          <td>
                            <strong
                              ><%= detail.total.toLocaleString('vi-VN')
                              %>đ</strong
                            >
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>

                    <div class="text-end">
                      <strong
                        >Tổng phòng <%= roomDetail.room.MaPhong %>:</strong
                      >
                      <span class="text-primary">
                        <%= roomDetail.subtotal.toLocaleString('vi-VN') %>đ
                      </span>
                    </div>
                  </div>
                  <% }) %>

                  <div class="total-section mt-4">
                    <div class="d-flex justify-content-between mb-2">
                      <span
                        >Tạm tính (<%= allRoomsDetails.length %> phòng):</span
                      >
                      <strong><%= subtotal.toLocaleString('vi-VN') %>đ</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                      <span>Thuế VAT (10%):</span>
                      <strong><%= vat.toLocaleString('vi-VN') %>đ</strong>
                    </div>
                    <div class="d-flex justify-content-between pt-3 border-top">
                      <span class="fs-5 fw-semibold">Tổng thanh toán:</span>
                      <strong class="total-amount"
                        ><%= total.toLocaleString('vi-VN') %>đ</strong
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Phương thức thanh toán -->
            <div class="col-md-5">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <h5 class="card-title mb-3">Phương thức thanh toán</h5>

                  <div class="payment-method">
                    <div class="form-check mb-3 p-3 border rounded">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="payment"
                        id="cash"
                        checked
                      />
                      <label class="form-check-label fs-5" for="cash">
                        <i class="fas fa-money-bill-wave me-2"></i> Tiền mặt
                      </label>
                    </div>

                    <div class="form-check mb-3 p-3 border rounded">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="payment"
                        id="card"
                      />
                      <label class="form-check-label fs-5" for="card">
                        <i class="fas fa-credit-card me-2"></i> Thẻ tín dụng/Ghi
                        nợ
                      </label>
                    </div>

                    <div class="form-check mb-3 p-3 border rounded">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="payment"
                        id="bank"
                      />
                      <label class="form-check-label fs-5" for="bank">
                        <i class="fas fa-university me-2"></i> Chuyển khoản
                      </label>
                    </div>
                  </div>

                  <!-- Tóm tắt -->
                  <div class="alert alert-info mt-4">
                    <h6 class="alert-heading">
                      <i class="fas fa-info-circle me-2"></i>Tóm tắt đơn đặt
                      phòng
                    </h6>
                    <hr />
                    <div class="d-flex justify-content-between mb-2">
                      <span>Số phòng:</span>
                      <strong><%= allRoomsDetails.length %> phòng</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Thời gian:</span>
                      <strong>
                        <% if (totalHours <= 6) { %> <%= totalHours %> giờ <% }
                        else { %> <%= totalDays %> ngày <% } %>
                      </strong>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span>Tổng cộng:</span>
                      <strong class="text-primary fs-5">
                        <%= total.toLocaleString('vi-VN') %>đ
                      </strong>
                    </div>
                  </div>

                  <div class="d-grid gap-2 mt-4">
                    <button
                      class="btn btn-primary btn-lg"
                      onclick="confirmPayment()"
                    >
                      <i class="fas fa-check-circle me-2"></i> Xác nhận thanh
                      toán
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal thanh toán thành công -->
    <div
      class="modal fade"
      id="successModal"
      tabindex="-1"
      data-bs-backdrop="static"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center py-5">
            <i
              class="fas fa-check-circle text-success"
              style="font-size: 80px"
            ></i>
            <h3 class="mt-4">Thanh toán thành công!</h3>
            <p class="text-muted">
              Đơn #<%= booking.MaDatPhong %> đã được thanh toán
            </p>
            <button
              class="btn btn-primary mt-3"
              onclick="window.location.href='/receptions'"
            >
              Về trang chủ
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      async function confirmPayment() {
        if (!confirm("Xác nhận thanh toán đơn #<%= booking.MaDatPhong %>?")) {
          return;
        }

        try {
          const response = await fetch(
            "/receptions/payment/<%= booking.MaDatPhong %>",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          const data = await response.json();

          if (data.success) {
            const modal = new bootstrap.Modal(
              document.getElementById("successModal")
            );
            modal.show();
          } else {
            alert(data.message || "Có lỗi xảy ra");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Có lỗi xảy ra khi xử lý thanh toán");
        }
      }
    </script>
  </body>
</html>
