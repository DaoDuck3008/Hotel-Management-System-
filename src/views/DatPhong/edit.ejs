<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chỉnh sửa đơn đặt phòng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .shadow-card { box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    .form-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .removeDetailBtn { cursor: pointer; }
  </style>
</head>
<body>
<div class="container my-4">

  <h2 class="mb-4">Chỉnh sửa đơn đặt phòng #<%= booking.MaDatPhong %></h2>

  <form action="/bookings/<%= booking.MaDatPhong %>/edit" method="POST" class="shadow-card p-4 rounded">

    <!-- Thông tin khách hàng -->
    <div class="form-section mb-4">
      <h5 class="mb-3"><i class="fas fa-user me-2"></i>Thông tin khách hàng</h5>
      <div class="row mb-2">
        <div class="col-md-4">
          <label class="fw-bold">Họ và tên</label>
          <input type="text" name="HoVaTen" class="form-control" value="<%= booking.KhachHang.HoVaTen %>" required>
        </div>
        <div class="col-md-2">
          <label class="fw-bold">Giới tính</label>
          <select name="GioiTinh" class="form-control">
            <option value="Nam" <%= booking.KhachHang.GioiTinh === 'Nam' ? 'selected' : '' %>>Nam</option>
            <option value="Nữ" <%= booking.KhachHang.GioiTinh === 'Nữ' ? 'selected' : '' %>>Nữ</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="fw-bold">Ngày sinh</label>
          <input type="date" name="NgaySinh" class="form-control"
            value="<%= booking.KhachHang.NgaySinh ? new Date(booking.KhachHang.NgaySinh).toISOString().slice(0,10) : '' %>">
        </div>
        <div class="col-md-3">
          <label class="fw-bold">SĐT</label>
          <input type="text" name="SDT" class="form-control" value="<%= booking.KhachHang.SDT %>">
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <label class="fw-bold">Email</label>
          <input type="email" name="Email" class="form-control" value="<%= booking.KhachHang.Email %>">
        </div>
      </div>
    </div>

    <!-- Thời gian đặt phòng -->
    <div class="form-section mb-4">
      <h5 class="mb-3"><i class="fas fa-calendar-alt me-2"></i>Thời gian đặt phòng</h5>
      <div class="row">
        <div class="col-md-4 mb-2">
          <label class="fw-bold">Ngày đặt</label>
          <input type="date" name="NgayDat" class="form-control" value="<%= booking.NgayDat ? new Date(booking.NgayDat).toISOString().slice(0,10) : '' %>">
        </div>
        <div class="col-md-4 mb-2">
          <label class="fw-bold">Ngày nhận</label>
          <input type="date" name="NgayNhanPhong" class="form-control" value="<%= booking.NgayNhanPhong ? new Date(booking.NgayNhanPhong).toISOString().slice(0,10) : '' %>">
        </div>
        <div class="col-md-4 mb-2">
          <label class="fw-bold">Ngày trả</label>
          <input type="date" name="NgayTraPhong" class="form-control" value="<%= booking.NgayTraPhong ? new Date(booking.NgayTraPhong).toISOString().slice(0,10) : '' %>">
        </div>
      </div>
    </div>

    <!-- Chi tiết phòng -->
    <div class="form-section mb-4">
      <h5 class="mb-3"><i class="fas fa-door-open me-2"></i>Danh sách phòng</h5>
      <div id="roomDetails">
        <% booking.ChiTiet.forEach((ct, index) => { %>
        <div class="detail-item border rounded p-3 mb-3 bg-white shadow-sm">
          <div class="row">
            <div class="col-md-3 mb-2">
              <label class="fw-bold">Chọn phòng</label>
              <select name="ChiTiet[<%= index %>][MaPhong]" class="form-select room-select" required>
                <% rooms.forEach(room => { %>
                  <option value="<%= room.MaPhong %>" <%= room.MaPhong === ct.MaPhong ? 'selected' : '' %>>
                    <%= room.TenPhong %> - <%= room.LoaiPhong.TenLoai %>
                  </option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-2 mb-2">
              <label class="fw-bold">Giá ngày</label>
              <input type="number" name="ChiTiet[<%= index %>][GiaNgay]" class="form-control" value="<%= ct.GiaNgay %>" readonly>
            </div>
            <div class="col-md-2 mb-2">
              <label class="fw-bold">Giá giờ</label>
              <input type="number" name="ChiTiet[<%= index %>][GiaGio]" class="form-control" value="<%= ct.GiaGio %>" readonly>
            </div>
            <div class="col-md-1 text-end">
              <button type="button" class="btn btn-danger btn-sm removeDetailBtn"><i class="fas fa-trash"></i> Xóa</button>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
      <button type="button" id="addRoomBtn" class="btn btn-outline-primary mb-2"><i class="fas fa-plus"></i> Thêm phòng</button>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-success px-4"><i class="fas fa-save me-1"></i> Lưu thay đổi</button>
      <a href="/bookings" class="btn btn-secondary">Quay lại</a>
    </div>

  </form>
</div>

<script>
let index = <%= booking.ChiTiet.length %>;

// Cập nhật giá theo phòng chọn
function updatePriceFromSelect(select) {
  const block = select.closest(".detail-item");
  const option = select.selectedOptions[0];
  block.querySelector(".room-price-day")?.setAttribute('value', option.dataset.giaNgay || 0);
  block.querySelector(".room-price-hour")?.setAttribute('value', option.dataset.giaGio || 0);
}

document.querySelectorAll(".room-select").forEach(select => {
  updatePriceFromSelect(select);
  select.addEventListener("change", () => updatePriceFromSelect(select));
});

// Thêm phòng mới
document.getElementById("addRoomBtn").addEventListener("click", () => {
  const block = document.createElement("div");
  block.className = "detail-item border rounded p-3 mb-3 bg-white shadow-sm";

  let options = '';
  <% rooms.forEach(room => { %>
    options += `<option value="<%= room.MaPhong %>" data-gia-ngay="<%= room.GiaNgay %>" data-gia-gio="<%= room.GiaGio %>"><%= room.TenPhong %> - <%= room.LoaiPhong.TenLoai %></option>`;
  <% }) %>

  block.innerHTML = `
    <div class="row">
      <div class="col-md-3 mb-2">
        <label class="fw-bold">Chọn phòng</label>
        <select name="ChiTiet[${index}][MaPhong]" class="form-select room-select" required>
          ${options}
        </select>
      </div>
      <div class="col-md-2 mb-2">
        <label class="fw-bold">Giá ngày</label>
        <input type="number" name="ChiTiet[${index}][GiaNgay]" class="form-control room-price-day" readonly>
      </div>
      <div class="col-md-2 mb-2">
        <label class="fw-bold">Giá giờ</label>
        <input type="number" name="ChiTiet[${index}][GiaGio]" class="form-control room-price-hour" readonly>
      </div>
      <div class="col-md-1 text-end">
        <button type="button" class="btn btn-danger btn-sm removeDetailBtn"><i class="fas fa-trash"></i> Xóa</button>
      </div>
    </div>
  `;
  document.getElementById("roomDetails").appendChild(block);

  const newSelect = block.querySelector(".room-select");
  updatePriceFromSelect(newSelect);
  newSelect.addEventListener("change", () => updatePriceFromSelect(newSelect));

  index++;
});

// Xóa phòng
document.addEventListener("click", (e) => {
  if (e.target.closest(".removeDetailBtn")) {
    e.target.closest(".detail-item").remove();
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
