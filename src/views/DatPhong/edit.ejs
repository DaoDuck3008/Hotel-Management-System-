<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chỉnh sửa Đơn Đặt Phòng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .shadow-card {
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      }
      .form-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Thông báo -->
    <div
      class="d-flex justify-content-end pt-1 pe-1"
      style="position: fixed; right: 0; top: 0; z-index: 1000"
    >
      <%- include('../partials/notification.ejs') %>
    </div>

    <div class="container-fluid">
      <div class="row">
         <!-- sidebar -->
         <%- include('../partials/sidebar.ejs') %>

        <!-- Main content -->
        <div class="col-md-9 col-lg-10 ms-auto p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Chỉnh sửa đơn đặt phòng</h2>
            <a href="/bookings" class="btn btn-secondary"
              ><i class="fas fa-arrow-left me-1"></i> Quay lại</a
            >
          </div>

          <!-- FORM EDIT -->
          <form
            action="/bookings/<%= booking.DatPhong.MaDatPhong %>/edit"
            method="POST"
            class="shadow-card p-4 rounded"
          >
            <input type="hidden" name="rooms" id="roomsInput" />

            <!-- KHÁCH HÀNG -->
            <div class="form-section mb-4">
              <h5 class="mb-3">
                <i class="fas fa-user me-2"></i>Thông tin khách hàng
              </h5>

              <div class="row mb-2">
                <div class="col-md-4">
                  <label class="fw-bold">Họ và tên</label>
                  <input
                    type="text"
                    name="HoVaTen"
                    class="form-control"
                    required
                    value="<%= booking.KhachHang.HoVaTen %>"
                  />
                </div>

                <div class="col-md-2">
                  <label class="fw-bold">Giới tính</label>
                  <input
                    type="text"
                    name="GioiTinh"
                    class="form-control"
                    required
                    value="<%= booking.KhachHang.GioiTinh %>"
                  />
                </div>

                <div class="col-md-3">
                  <label class="fw-bold">Ngày sinh</label>
                  <input
                    type="date"
                    name="NgaySinh"
                    class="form-control"
                    required
                    value="<%= new Date(booking.KhachHang.NgaySinh).toISOString().slice(0,10) %>"
                  />
                </div>

                <div class="col-md-3">
                  <label class="fw-bold">SĐT</label>
                  <input
                    type="text"
                    name="SDT"
                    class="form-control"
                    required
                    value="<%= booking.KhachHang.SDT %>"
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <label class="fw-bold">Email</label>
                  <input
                    type="email"
                    name="Email"
                    class="form-control"
                    required
                    value="<%= booking.KhachHang.Email %>"
                  />
                </div>
              </div>
            </div>

            <!-- NGÀY NHẬN/TRẢ -->
            <div class="form-section mb-4">
              <h5 class="mb-3">
                <i class="fas fa-calendar-alt me-2"></i>Thời gian đặt phòng
              </h5>

              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="fw-bold">Ngày nhận</label>
                  <input
                    type="date"
                    name="NgayNhanPhong"
                    class="form-control"
                    required
                    value="<%= booking.DatPhong.NgayNhanPhong.toISOString().slice(0, 10) %>"
                    />
                </div>

                <div class="col-md-4 mb-2">
                  <label class="fw-bold">Ngày trả</label>
                  <input
                    type="date"
                    name="NgayTraPhong"
                    class="form-control"
                    required
                    value="<%= booking.DatPhong.NgayTraPhong.toISOString().slice(0, 10) %>"
                    />
                </div>
              </div>
            </div>

            <!-- DANH SÁCH PHÒNG -->
            <div class="form-section mb-4">
              <h5 class="mb-3"><i class="fas fa-door-open me-2"></i>Danh sách phòng</h5>

              <div id="roomDetails">

                <% booking.ChiTiet.forEach((room, idx) => { %>
                  <div class="detail-item border rounded p-3 mb-3">
                    <div class="row">
                  
                      <!-- Mã phòng -->
                      <div class="col-md-3 mb-2">
                        <label class="fw-bold">Mã phòng</label>
                        <select class="form-select room-select" name="MaPhong[]" required>
                          <option value="">-- Chọn phòng --</option>
                  
                          <% allRooms.forEach(r => { %>
                            <option value="<%= r.MaPhong %>"
                              <%= r.MaPhong === room.MaPhong ? "selected" : "" %>>
                              <%= r.MaPhong %> - <%= r.TenPhong %>
                            </option>
                          <% }) %>
                        </select>
                      </div>
                  
                      <!-- Loại giá -->
                      <div class="col-md-2 mb-2">
                        <label class="fw-bold">Loại giá</label>
                        <select class="form-select" name="LoaiGia[]" required>
                          <option value="Giá Ngày" <%= room.ChiTietGiaDatPhong[0].LoaiGia === "Giá Ngày" ? "selected" : "" %>>Giá ngày</option>
                          <option value="Giá Giờ" <%= room.ChiTietGiaDatPhong[0].LoaiGia === "Giá Giờ" ? "selected" : "" %>>Giá giờ</option>
                        </select>
                      </div>
                  
                      <!-- Giá từng ngày -->
                      <div class="col-md-6 mb-2">
                        <label class="fw-bold">Giá theo từng ngày</label>
                  
                        <div class="price-detail-list border rounded p-2"
                          style="background:#f0f0f0;max-height:200px;overflow:auto;">
                          
                          <% room.ChiTietGiaDatPhong.forEach(item => { %>
                            <div class="d-flex justify-content-between border-bottom py-1">
                              <span><%= item.Ngay %></span>
                              <strong>Ngày: <%= item.GiaNgay.toLocaleString() %> |
                                      Giờ: <%= item.GiaGio.toLocaleString() %></strong>
                            </div>
                          <% }) %>
                  
                        </div>
                  
                        <!-- INPUT HIDDEN SỬA ĐÚNG -->
                        <input type="hidden" class="gia-theo-ngay-hidden"
                               value='<%= JSON.stringify(room.ChiTietGiaDatPhong) %>' />
                      </div>
                  
                      <!-- NÚT XÓA PHÒNG -->
                      <% if (idx === 0) { %>
                        <div class="col-md-1 d-flex align-items-start">
                          <!-- Để trống chỗ nút xóa cho phòng đầu tiên -->
                        </div>
                      <% } else { %>
                      <div class="col-md-1 d-flex align-items-start">
                        <button type="button" class="btn btn-danger btn-sm remove-room-btn">Xóa</button>
                      </div>
                      <% } %>
                    </div>
                  </div>
                  
                <% }) %>
              </div>

              <!-- Thêm phòng -->
              <button type="button" id="addRoomBtn" class="btn btn-outline-primary mb-2">
                <i class="fas fa-plus"></i> Thêm phòng
              </button>
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-success px-4">
                <i class="fas fa-save me-1"></i> Lưu thay đổi
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>

      // Gán sự kiện xóa cho các phòng cũ
      document.querySelectorAll(".remove-room-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          btn.closest(".detail-item").remove();
        });
      });

      /* ========== GIỮ NGUYÊN CÁC FUNCTION loadAvailableRooms & updatePriceRange
                     từ file create.ejs vì chúng hoạt động tốt ========== */

      function normalizeDateInput(dateStr) {
        if (!dateStr) return null;
        if (dateStr.includes("/")) {
          const [dd, mm, yyyy] = dateStr.split("/");
          return `${yyyy}-${mm}-${dd}`;
        }
        return dateStr;
      }

      function getSafeDateInput(selector) {
        return normalizeDateInput(document.querySelector(selector).value);
      }

      async function loadAvailableRooms(selectElement) {
        const from = getSafeDateInput("input[name='NgayNhanPhong']");
        const to = getSafeDateInput("input[name='NgayTraPhong']");

        if (!from || !to) return;

        const res = await fetch(`/api/rooms/available?from=${from}&to=${to}`);
        const data = await res.json();

        selectElement.innerHTML =
          '<option value="">-- Chọn phòng --</option>';

        if (!data.rooms || data.rooms.length === 0) {
          selectElement.innerHTML += `<option disabled>Không có phòng trống</option>`;
          return;
        }

        data.rooms.forEach((room) => {
          selectElement.innerHTML += `
            <option value="${room.MaPhong}">
              ${room.MaPhong} - ${room.TenPhong}
            </option>
          `;
        });
      }

      async function updatePriceRange(selectElement) {
        const block = selectElement.closest(".detail-item");
        const MaPhong = selectElement.value;

        const from = getSafeDateInput("input[name='NgayNhanPhong']");
        const to = getSafeDateInput("input[name='NgayTraPhong']");

        if (!MaPhong || !from || !to) return;

        const res = await fetch(
          `/api/rooms/price-range?MaPhong=${MaPhong}&from=${from}&to=${to}`
        );
        const data = await res.json();

        const list = block.querySelector(".price-detail-list");
        const inputGiaTheoNgay = block.querySelector(".gia-theo-ngay-hidden");

        list.innerHTML = "";

        let giaTheoNgay = [];

        data.prices.forEach((item) => {
          list.innerHTML += `
            <div class="d-flex justify-content-between border-bottom py-1">
              <span>${item.date}</span>
              <strong>Ngày: ${item.giaNgay.toLocaleString()} | Giờ: ${item.giaGio.toLocaleString()}</strong>
            </div>
          `;

          giaTheoNgay.push({
            Ngay: item.date,
            GiaNgay: item.giaNgay,
            GiaGio: item.giaGio,
          });
        });

        inputGiaTheoNgay.value = JSON.stringify(giaTheoNgay);
      }

      // Khi đổi ngày -> cập nhật danh sách phòng trống
      ["NgayNhanPhong", "NgayTraPhong"].forEach((name) => {
        document
          .querySelector(`input[name='${name}']`)
          .addEventListener("change", () => {
            document.querySelectorAll(".room-select").forEach((select) => {
              loadAvailableRooms(select);
            });
          });
      });

      // Khi đổi phòng -> update giá
      document.addEventListener("change", (e) => {
        if (e.target.classList.contains("room-select")) {
          updatePriceRange(e.target);
        }
      });

      // =============== ADD ROOM ===============
      document.getElementById("addRoomBtn").addEventListener("click", () => {
        const container = document.getElementById("roomDetails");

        const newBlock = document.createElement("div");
        newBlock.classList.add(
          "detail-item",
          "border",
          "rounded",
          "p-3",
          "mb-3"
        );

        newBlock.innerHTML = `
          <div class="row">
            <div class="col-md-3 mb-2">
              <label class="fw-bold">Mã phòng</label>
              <select class="form-select room-select" name="MaPhong[]" required>
                <option value="">-- Chọn phòng trống --</option>
              </select>
            </div>

            <div class="col-md-2 mb-2">
              <label class="fw-bold">Loại giá</label>
              <select class="form-select" name="LoaiGia[]" required>
                <option value="Giá Ngày">Giá ngày</option>
                <option value="Giá Giờ">Giá giờ</option>
              </select>
            </div>

            <div class="col-md-6 mb-2">
              <label class="fw-bold">Giá theo từng ngày</label>
              <div class="price-detail-list border rounded p-2"
                   style="background:#f0f0f0;max-height:200px;overflow:auto;">
              </div>

              <input type="hidden" class="gia-theo-ngay-hidden">
            </div>

            <div class="col-md-1 d-flex align-items-start">
              <button type="button" class="btn btn-danger btn-sm remove-room-btn">Xóa</button>
            </div>
          </div>
        `;

        container.appendChild(newBlock);

        loadAvailableRooms(newBlock.querySelector(".room-select"));

        newBlock
          .querySelector(".remove-room-btn")
          .addEventListener("click", () => newBlock.remove());
      });

      // =============== SUBMIT -> rooms[] ===============
      document.querySelector("form").addEventListener("submit", function () {
        const roomBlocks = document.querySelectorAll(".detail-item");

        const rooms = [];

        roomBlocks.forEach((block) => {
          const MaPhong = block.querySelector("select[name='MaPhong[]']").value;
          const LoaiGia = block.querySelector("select[name='LoaiGia[]']").value;

          const giaTheoNgay = JSON.parse(
            block.querySelector(".gia-theo-ngay-hidden").value
          );

          rooms.push({
            MaPhong,
            LoaiGia,
            ChiTietGiaDatPhong: giaTheoNgay,
          });
        });

        document.getElementById("roomsInput").value = JSON.stringify(rooms);
      });
    </script>
  </body>
</html>
