<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cập nhật Phòng - Hệ thống Khách sạn</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .image-upload {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #f8f9fa;
      }
      .image-upload:hover {
        border-color: #0d6efd;
        background: #e7f1ff;
      }
      .upload-icon {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 1rem;
      }
      .image-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      .preview-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #dee2e6;
      }
      .preview-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
      }
      .remove-image {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
      }
      .amenity-checkbox {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
      }
      .amenity-checkbox:hover {
        background-color: #f8f9fa;
      }
      .amenity-checkbox.checked {
        background-color: #e7f1ff;
        border-color: #0d6efd;
      }
      .form-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #dee2e6;
      }
      .section-title {
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
        color: #495057;
        font-weight: 600;
      }
      .required::after {
        content: " *";
        color: #dc3545;
      }
    </style>
  </head>
  <body class="bg-light">
    <!-- Thông báo -->
    <div
      class="d-flex justify-content-end pt-1 pe-1"
      style="position:fixed ; top: 0; z-index: 1000"
    >
      <%- include('../partials/notification.ejs') %>
    </div>

    <div class="container py-4">
      <!-- Header -->
      <header class="bg-white shadow-sm rounded p-4 mb-4">
        <div
          class="d-flex justify-content-between align-items-center flex-wrap gap-3"
        >
          <h1 class="h3 mb-0 text-dark">Cập nhật Phòng <%= room.MaPhong %></h1>
          <a href="/rooms" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Quay lại danh sách
          </a>
        </div>
      </header>

      <!-- Edit Form -->
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <!-- form sử dụng method override: POST + ?_method=PUT -->
          <form
            id="roomEditForm"
            action="/rooms/<%= room.MaPhong %>?_method=PUT"
            method="POST"
            enctype="multipart/form-data"
          >
            <!-- Basic Information -->
            <div class="form-section">
              <h3 class="section-title">Thông tin cơ bản</h3>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="maPhong" class="form-label required">Mã phòng</label>
                  <!-- khóa không cho edit (nếu muốn edit mã phòng, bỏ readonly) -->
                  <input
                    type="text"
                    class="form-control"
                    id="maPhong"
                    name="maPhong"
                    placeholder="VD: P101"
                    value="<%= room.MaPhong %>"
                    required
                    readonly
                  />
                  <div class="form-text">
                    Mã phòng (khóa, không thể thay đổi).
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="tenPhong" class="form-label required">Tên phòng</label>
                  <input
                    type="text"
                    class="form-control"
                    id="tenPhong"
                    name="tenPhong"
                    placeholder="VD: Deluxury Ocean View"
                    value="<%= room.TenPhong %>"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label for="loaiPhong" class="form-label required">Loại phòng</label>
                  <select
                    class="form-select"
                    id="loaiPhong"
                    name="loaiPhong"
                    required
                  >
                    <option value="">Chọn loại phòng</option>
                    <% if(roomTypes && roomTypes.length > 0) {
                      roomTypes.forEach((roomType) => { %>
                        <option value="<%= roomType.TenLoaiPhong %>"
                          <%= roomType.TenLoaiPhong === room.TenLoaiPhong ? 'selected' : '' %>>
                          <%= roomType.TenLoaiPhong %>
                        </option>
                    <% }) } %>
                  </select>
                </div>

                <div class="col-md-6">
                  <label for="trangThai" class="form-label required">Trạng thái</label>
                  <select
                    class="form-select"
                    id="trangThai"
                    name="trangThai"
                    disabled
                  >
                    <option value="Empty" <%= (room.TrangThaiPhong && room.TrangThaiPhong.length && room.TrangThaiPhong[0].TrangThai === 'Empty') ? `Empty` : `` %>>Trống</option>
                    <!-- trạng thái này hiển thị nhưng không edit trực tiếp ở đây -->
                  </select>
                </div>

                <div class="col-md-6">
                  <label for="soGiuong" class="form-label required">Số giường</label>
                  <input
                    type="number"
                    class="form-control"
                    id="soGiuong"
                    name="soGiuong"
                    min="1"
                    value="<%= room.SoGiuong ? room.SoGiuong : 1 %>"
                    required
                  />
                  <div class="form-text">Số lượng giường tối thiểu: 1</div>
                </div>

                <div class="col-md-6">
                  <label for="sucChua" class="form-label required">Sức chứa</label>
                  <input
                    type="number"
                    class="form-control"
                    id="sucChua"
                    name="sucChua"
                    min="1"
                    value="<%= room.SucChua ? room.SucChua : 1 %>"
                    required
                  />
                  <div class="form-text">Số người tối đa có thể chứa</div>
                </div>

                <div class="col-12">
                  <label for="moTa" class="form-label">Mô tả thêm</label>
                  <textarea
                    class="form-control"
                    id="moTa"
                    name="moTa"
                    rows="3"
                    placeholder="Mô tả chi tiết về phòng..."
                  ><%= room.MoTa ? room.MoTa : '' %></textarea>
                  <div class="form-text">Mô tả thêm về phòng (nếu có)</div>
                </div>
              </div>
            </div>

            <!-- Pricing -->
            <div class="form-section mb-5">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="section-title">Thông tin giá</h3>
              </div>

              <!-- 1. Giá cơ bản -->
              <h5 class="mb-3">Giá cơ bản</h5>
              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label for="giaTheoNgay" class="form-label required">Giá theo ngày (VNĐ)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="giaTheoNgay"
                    name="giaTheoNgay"
                    placeholder="VD: 2500000"
                    min="0"
                    value="<%= room.GiaNgayCB %>"
                    required
                  />
                  <div class="form-text">Giá không được âm</div>
                </div>

                <div class="col-md-6">
                  <label for="giaTheoGio" class="form-label">Giá theo giờ (VNĐ)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="giaTheoGio"
                    name="giaTheoGio"
                    placeholder="VD: 500000"
                    min="0"
                    value="<%= room.GiaGioCB %>"
                  />
                  <div class="form-text">Giá không được âm</div>
                </div>
              </div>

              <hr class="mb-4" />

              <!-- 2. Giá theo từng ngày trong tuần -->
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Giá theo từng ngày trong tuần</h5>
                <small class="text-muted">* Nếu để trống thì sẽ dùng giá cơ bản</small>
              </div>

              <div class="row g-3 mb-4">
                <% 
                  const giaTuan = room.GiaPhongTuan ? room.GiaPhongTuan : [];
                  const giaTuanMap = {};
                  giaTuan.forEach(item => {
                    giaTuanMap[item.ThuApDung] = item;
                  });
                %>

                <% for(let thu = 2; thu <= 8; thu++) { 
                     const label = thu === 8 ? 'Chủ nhật' : 'Thứ ' + thu;
                     const item = giaTuanMap[thu];
                %>
                <div class="col-md-6">
                  <label class="form-label"><%= label %></label>
                  <div class="input-group">
                    <input type="hidden" name="giaThu[<%= thu %>][thu]" value="<%= thu %>" />
                    <input
                      type="number"
                      class="form-control"
                      name="giaThu[<%= thu %>][giaNgay]"
                      placeholder="Giá theo ngày"
                      min="0"
                      value="<%= item ? item.GiaNgay : '' %>"
                    />
                    <input
                      type="number"
                      class="form-control"
                      name="giaThu[<%= thu %>][giaGio]"
                      placeholder="Giá theo giờ"
                      min="0"
                      value="<%= item ? item.GiaGio : '' %>"
                    />
                  </div>
                </div>
                <% } %>
              </div>

              <hr class="mb-4" />

              <!-- 3. Giá ngày lễ -->
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Giá ngày lễ</h5>
                <button type="button" class="btn btn-primary" onclick="addNgayLe()">
                  <i class="fas fa-plus me-2"></i> Thêm ngày lễ
                </button>
              </div>

              <div id="ngayLeContainer">
                <% 
                  const ngayLeList = room.GiaPhongNgayLe ? room.GiaPhongNgayLe : [];
                  let startingNgayLeIndex = 0;
                  for(let i = 0; i < ngayLeList.length; i++) {
                    startingNgayLeIndex = i + 1;
                    const le = ngayLeList[i];
                %>
                  <div class="border rounded p-3 mb-3 bg-light ngay-le-item" data-index="<%= i+1 %>">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6 class="mb-0">Ngày lễ #<%= i+1 %></h6>
                      <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.ngay-le-item').remove()">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>

                    <div class="row g-3">
                      <div class="col-md-4">
                        <label class="form-label required">Tên ngày lễ</label>
                        <input type="text" class="form-control" name="giaLe[<%= i+1 %>][ten]" required value="<%= le.NgayLe  %>">
                      </div>

                      <div class="col-md-4">
                        <label class="form-label required">Ngày bắt đầu</label>
                        <input type="date" class="form-control" name="giaLe[<%= i+1 %>][start]" required value="<%= le.NgayBatDau ? new Date(le.NgayBatDau).toISOString().slice(0,10) : '' %>">
                      </div>

                      <div class="col-md-4">
                        <label class="form-label required">Ngày kết thúc</label>
                        <input type="date" class="form-control" name="giaLe[<%= i+1 %>][end]" required value="<%= le.NgayKetThuc ? new Date(le.NgayKetThuc).toISOString().slice(0,10) : '' %>">
                      </div>

                      <div class="col-md-6">
                        <label class="form-label required">Giá ngày (VNĐ)</label>
                        <input type="number" class="form-control" name="giaLe[<%= i+1 %>][giaNgay]" required min="0" value="<%= le.GiaNgay %>">
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Giá giờ (VNĐ)</label>
                        <input type="number" class="form-control" name="giaLe[<%= i+1 %>][giaGio]" min="0" value="<%= le.GiaGio  %>">
                      </div>
                    </div>
                  </div>
                <% } %>
              </div>
            </div>

            <!-- Ảnh -->
            <div class="form-section">
              <h3 class="section-title">Hình ảnh phòng</h3>

              <div class="mb-3">
                <label class="form-label">Ảnh hiện có</label>
                <div class="image-preview" id="existingImagePreview">
                  <% if(room.HinhAnh && room.HinhAnh.length > 0) { 
                       room.HinhAnh.forEach((h, idx) => { %>
                         <div class="preview-item existing-item" data-id="<%= h.MaHinhAnh %>">
                           <img src="<%= h.ImgURL %>" alt="Hình <%= idx+1 %>">
                           <button type="button" class="remove-image btn-remove-existing" title="Xóa hình">
                             <i class="fas fa-times"></i>
                           </button>
                         </div>
                  <% }) } else { %>
                    <p class="text-muted">Chưa có ảnh nào.</p>
                  <% } %>
                </div>
              </div>

              <div class="image-upload" id="imageUpload">
                <div class="upload-icon">
                  <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="fw-medium mb-2">Nhấp để tải lên hình ảnh mới</div>
                <div class="text-muted small">
                  Hỗ trợ JPG, PNG, WEBP (Tối đa 5MB mỗi ảnh)
                </div>
              </div>

              <input
                type="file"
                id="imageInput"
                name="images"
                multiple
                accept="image/*"
                class="d-none"
              />
              <div class="image-preview" id="imagePreview"></div>

              <!-- hidden inputs for deleted existing images -->
              <div id="deletedImagesInputs"></div>
            </div>

            <!-- Amenities -->
            <div class="form-section">
              <h3 class="section-title">Tiện ích phòng</h3>
              <div class="row g-2">
                <div class="d-flex flex-wrap gap-3 justify-content-center">
                  <% 
                    // Build set of existing amenity ids for quick lookup
                    const existAmenities = new Set((room.TienIch || []).map(t => String(t.MaTienIch)));
                    if(amenities && amenities.length > 0) {
                      amenities.forEach((amenity) => { %>
                        <div class="amenity-checkbox form-check p-3 rounded <%= room.TienIch.some(ti => ti.MaTienIch === amenity.MaTienIch) ? 'checked' : '' %>">
                          <input
                            id="amenity-<%= amenity.MaTienIch %>"
                            class="form-check-input"
                            type="checkbox"
                            name="tienIch"
                            value="<%= amenity.MaTienIch %>"
                            <%= room.TienIch.some(ti => ti.MaTienIch === amenity.MaTienIch) ? 'checked' : '' %>
                          />
                          <label class="form-check-label d-flex align-items-center" for="amenity-<%= amenity.MaTienIch %>">
                            <i class="fas <%= amenity.IconURL %> me-2 text-primary"></i>
                            <%= amenity.TenTienIch %>
                          </label>
                        </div>
                  <% }) } %>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="border-top pt-4 mt-4">
              <div class="d-flex gap-3 flex-wrap justify-content-end">
                <a href="/rooms" class="btn btn-outline-secondary">
                  <i class="fas fa-times me-2"></i>
                  Hủy bỏ
                </a>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save me-2"></i>
                  Cập nhật phòng
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="countLe"> <%= (room.GiaPhongNgayLe && room.GiaPhongNgayLe.length) ? room.GiaPhongNgayLe.length : 0 %></div>

    <!-- Bootstrap bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // === Ngày lễ dynamic ===
      const countLe = document.getElementById('countLe');
      let ngayLeIndex = countLe.value ? parseInt(countLe.value) : 0;

      function addNgayLe() {
        ngayLeIndex++;
        const idx = ngayLeIndex;
        const html = `
        <div class="border rounded p-3 mb-3 bg-light ngay-le-item" data-index="${idx}">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Ngày lễ #${idx}</h6>
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.ngay-le-item').remove()">
              <i class="fas fa-trash"></i>
            </button>
          </div>

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label required">Tên ngày lễ</label>
              <input type="text" class="form-control" name="giaLe[${idx}][ten]" required>
            </div>

            <div class="col-md-4">
              <label class="form-label required">Ngày bắt đầu</label>
              <input type="date" class="form-control" name="giaLe[${idx}][start]" required>
            </div>

            <div class="col-md-4">
              <label class="form-label required">Ngày kết thúc</label>
              <input type="date" class="form-control" name="giaLe[${idx}][end]" required>
            </div>

            <div class="col-md-6">
              <label class="form-label required">Giá ngày (VNĐ)</label>
              <input type="number" class="form-control" name="giaLe[${idx}][giaNgay]" min="0">
            </div>

            <div class="col-md-6">
              <label class="form-label">Giá giờ (VNĐ)</label>
              <input type="number" class="form-control" name="giaLe[${idx}][giaGio]" min="0">
            </div>
          </div>
        </div>
      `;
        document.getElementById('ngayLeContainer').insertAdjacentHTML('beforeend', html);
      }

      // === Amenity checkbox UI ===
      document.querySelectorAll('.amenity-checkbox input[type="checkbox"]').forEach((checkbox) => {
        checkbox.addEventListener('change', function () {
          const label = this.closest('.amenity-checkbox');
          if (this.checked) label.classList.add('checked');
          else label.classList.remove('checked');
        });

        // init state
        if (checkbox.checked) checkbox.closest('.amenity-checkbox').classList.add('checked');
      });

      // === Image upload & preview (supports keeping existing images + adding new ones) ===
      const imageUpload = document.getElementById("imageUpload");
      const imageInput = document.getElementById("imageInput");
      const imagePreview = document.getElementById("imagePreview");
      const existingPreview = document.getElementById("existingImagePreview");
      const deletedImagesInputs = document.getElementById("deletedImagesInputs");

      let allFiles = []; // new files to upload
      let existingImages = []; // track existing images (objects: {id, url})

      // initialize existingImages from DOM dataset
      (function initExisting() {
        const els = existingPreview ? existingPreview.querySelectorAll('.existing-item') : [];
        els.forEach(el => {
          existingImages.push({
            id: el.getAttribute('data-id'),
            url: el.querySelector('img').src
          });
        });
      })();

      // click open file dialog
      imageUpload.addEventListener("click", () => {
        imageInput.click();
      });

      // when new files selected
      imageInput.addEventListener("change", function (e) {
        const newFiles = Array.from(e.target.files);
        // merge
        allFiles = allFiles.concat(newFiles);

        // reset FileList
        const dt = new DataTransfer();
        allFiles.forEach(f => dt.items.add(f));
        imageInput.files = dt.files;

        // render previews for new files
        newFiles.forEach(file => {
          if (!file.type.startsWith("image/")) return;
          const reader = new FileReader();
          reader.onload = function(ev) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
              <img src="${ev.target.result}">
              <button type="button" class="remove-image">
                <i class="fas fa-times"></i>
              </button>
            `;
            imagePreview.appendChild(previewItem);
          };
          reader.readAsDataURL(file);
        });
      });

      // remove either existing or newly added preview
      document.addEventListener("click", function(e) {
        // remove new file preview
        if (e.target.closest(".remove-image") && e.target.closest(".preview-item")) {
          const btn = e.target.closest(".remove-image");
          const item = btn.closest(".preview-item");
          const index = Array.from(imagePreview.children).indexOf(item);
          if (index > -1) {
            // remove from allFiles
            allFiles.splice(index, 1);
            const dt = new DataTransfer();
            allFiles.forEach(f => dt.items.add(f));
            imageInput.files = dt.files;
            item.remove();
          }
          return;
        }
      });
    
      // XÓA ẢNH HIỆN CÓ
    document.addEventListener("click", function (e) {
        const btn = e.target.closest(".btn-remove-existing");
        if (!btn) return;

        const item = btn.closest(".existing-item");
        const imageId = item.dataset.id;
        console.log("Deleting existing image ID:", imageId);

        // Thêm hidden input để gửi về controller
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "deletedImages[]";
        input.value = imageId;

        document.getElementById("deletedImagesInputs").appendChild(input);

        // Xóa trong UI
        item.remove();
    });


      // === Optional: validate file size before submit (max 5MB each) ===
      document.getElementById('roomEditForm').addEventListener('submit', function(e) {
        const maxSize = 5 * 1024 * 1024; // 5MB
        for (const f of allFiles) {
          if (f.size > maxSize) {
            e.preventDefault();
            alert('Một trong các ảnh vượt quá 5MB. Vui lòng chọn ảnh nhỏ hơn 5MB.');
            return false;
          }
        }
      });
    </script>
  </body>
</html>
