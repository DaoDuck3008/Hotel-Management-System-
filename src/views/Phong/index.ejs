<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Phòng - Hệ thống Khách sạn</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .sidebar {
        background: linear-gradient(180deg, #2563eb 0%, #1d4ed8 100%);
        min-height: 100vh;
        transition: all 0.3s;
      }

      .sidebar.closed {
        margin-left: -260px;
      }

      .nav-link.active {
        background: #1e40af !important;
      }

      .room-card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .room-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        transform: translateY(-4px);
      }

      .room-image {
        height: 200px;
        overflow: hidden;
      }

      .room-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .room-status {
        position: absolute;
        top: 12px;
        right: 12px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        background-color: rgb(50, 158, 57);
        color: white;
      }

      .room-code {
        position: absolute;
        top: 12px;
        left: 12px;
        background: #2563eb;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .filter-section {
        display: none;
      }

      .filter-section.active {
        display: block;
      }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          z-index: 1000;
          margin-left: 0;
        }

        .sidebar.closed {
          margin-left: -260px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Thông báo -->
    <div
      class="d-flex justify-content-end pt-1 pe-1"
      style="position: sticky; top: 0; z-index: 1000"
    >
      <%- include('../partials/notification.ejs') %>
    </div>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar p-0" id="sidebar">
          <div class="sidebar-header p-3">
            <div class="logo d-flex align-items-center gap-3 mb-4">
              <i class="fas fa-hotel fa-2x text-white"></i>
              <h1 class="h5 text-white mb-0 fw-bold">Hotel MS</h1>
            </div>

            <ul class="nav flex-column">
              <li class="nav-item">
                <a
                  class="nav-link text-white d-flex justify-content-between align-items-center"
                  data-bs-toggle="collapse"
                  href="#roomSubmenu"
                  role="button"
                  aria-expanded="false"
                  aria-controls="roomSubmenu"
                >
                  <span> <i class="fas fa-bed me-2"></i> Bộ phận Phòng </span>

                  <i class="fas fa-chevron-down small"></i>
                </a>

                <div class="collapse ps-4" id="roomSubmenu">
                  <ul class="nav flex-column">
                    <li class="nav-item">
                      <a class="nav-link text-white" href="/rooms/statistics">
                        <i class="fas fa-chart-line me-2"></i>
                        Thống kê phòng
                      </a>
                    </li>

                    <li class="nav-item">
                      <a
                        class="nav-link text-white"
                        href="/rooms/price-settings"
                      >
                        <i class="fas fa-dollar-sign me-2"></i>
                        Điều chỉnh giá
                      </a>
                    </li>
                  </ul>
                </div>
              </li>

              <!-- Other menu items -->
              <li class="nav-item">
                <a class="nav-link text-white" data-menu="business">
                  <i class="fas fa-briefcase me-2"></i>
                  <span>Bộ phận Kinh doanh</span>
                </a>
              </li>

              <li class="nav-item">
                <a class="nav-link text-white" data-menu="hr">
                  <i class="fas fa-users me-2"></i>
                  <span>Bộ phận Nhân sự</span>
                </a>
              </li>

              <li class="nav-item">
                <a class="nav-link text-white" data-menu="receptions">
                  <i class="fas fa-user-circle me-2"></i>
                  <span>Bộ phận Lễ tân</span>
                </a>
              </li>
            </ul>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 ms-auto p-0">
          <!-- Header -->
          <header class="bg-white shadow-sm p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3" id="menuToggle">
                  <i class="fas fa-bars"></i>
                </button>
                <h2 class="h4 mb-0 text-dark">
                  <a href="/rooms" class="text-decoration-none"
                    >Quản lý Phòng</a
                  >
                </h2>
              </div>

              <div class="d-flex align-items-center gap-3">
                <div class="input-group" style="width: 300px">
                  <span class="input-group-text bg-white border-end-0">
                    <i class="fas fa-search text-muted"></i>
                  </span>
                  <input
                    type="text"
                    class="form-control border-start-0"
                    id="searchInput"
                    name="keyword"
                    placeholder="Tìm kiếm phòng..."
                    form="searchForm"
                  />
                </div>
                <button class="btn btn-outline-secondary" id="filterToggle">
                  <i class="fas fa-filter me-2"></i>
                  Bộ lọc
                </button>
                <a href="/rooms/create" class="btn btn-primary">
                  <i class="fas fa-plus me-2"></i> Thêm phòng
                </a>
              </div>
            </div>
          </header>

          <!-- Form tìm kiếm -->
          <div class="filter-section bg-white border-bottom" id="filterSection">
            <div class="container-fluid p-4">
              <form id="searchForm" method="get" action="/rooms/search">
                <div class="row g-3 mb-3">
                  <div class="col-md-4">
                    <label class="form-label fw-medium">Loại phòng</label>
                    <select
                      class="form-select"
                      name="loaiPhong"
                      id="roomTypeFilter"
                    >
                      <option value="">Tất cả loại phòng</option>

                      <% roomTypes.forEach(type => { %>
                      <option value="<%= type.TenLoaiPhong %>">
                        <%= type.TenLoaiPhong %>
                      </option>
                      <% }) %>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-medium"
                      >Khoảng giá theo ngày</label
                    >
                    <div class="row g-2">
                      <div class="col">
                        <input
                          type="number"
                          class="form-control"
                          id="minPrice"
                          name="giaTu"
                          placeholder="Giá thấp nhất"
                          min="0"
                        />
                      </div>
                      <div class="col-auto d-flex align-items-center">
                        <span class="text-muted">-</span>
                      </div>
                      <div class="col">
                        <input
                          type="number"
                          class="form-control"
                          id="maxPrice"
                          name="giaDen"
                          placeholder="Giá cao nhất"
                          min="0"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col">
                    <label class="form-label fw-medium"
                      >Sức chứa tối thiểu</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="sucChua"
                      name="sucChua"
                      placeholder="Sức chứa tối thiểu"
                      min="1"
                    />
                  </div>
                </div>
                <div class="d-flex justify-content-end gap-2">
                  <button class="btn btn-outline-secondary" id="resetFilters">
                    Đặt lại
                  </button>
                  <button class="btn btn-primary" id="applyFilters">
                    Áp dụng
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Danh sách phòng -->
          <div class="content p-4">
            <% if (rooms && rooms.length > 0) { %>
            <div class="row g-4" id="roomGrid">
              <% rooms.forEach(room => { if (!room) return; %>

              <div class="col-xl-4 col-lg-6 col-md-6">
                <div class="card room-card h-100">
                  <div class="room-image position-relative">
                    <img
                      src="<%= room.HinhAnh[0].ImgURL ? room.HinhAnh[0].ImgURL : '../../../../public/og.png' %>"
                      class="card-img-top"
                      alt="<%= room.tenPhong %>"
                    />
                    <div class="room-status position-absolute">
                      <%= room.getCurrentTrangThai() %>
                    </div>
                    <div class="room-code position-absolute">
                      <%= room.MaPhong %>
                    </div>
                  </div>
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title"><%= room.TenPhong %></h5>
                    <div class="card-text mb-3">
                      <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Loại phòng:</span>
                        <strong><%= room.LoaiPhong.TenLoaiPhong %></strong>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Giá theo ngày:</span>
                        <strong class="text-primary"
                          ><%= room.getGiaNgayToday().toLocaleString()
                          %></strong
                        >
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Giá theo giờ:</span>
                        <strong class="text-primary"
                          ><%= room.getGiaGioToday().toLocaleString() %></strong
                        >
                      </div>
                      <div class="d-flex justify-content-between">
                        <span class="text-muted">Sức chứa:</span>
                        <strong><%= room.SucChua %> người</strong>
                      </div>
                    </div>
                    <div class="mt-auto pt-3 border-top">
                      <div class="btn-group w-100" role="group">
                        <a
                          href="/rooms/<%= room.MaPhong %>"
                          class="btn btn-outline-primary"
                        >
                          <i class="fas fa-eye me-1"></i> Xem
                        </a>
                        <a
                          href="rooms/<%= room.MaPhong %>/edit"
                          class="btn btn-outline-success"
                        >
                          <i class="fas fa-edit me-1"></i> Sửa
                        </a>
                        <button
                          type="button"
                          class="btn btn-outline-danger"
                          onclick="showDeleteModal('<%= room.MaPhong %>', '<%= room.TenPhong %>')"
                        >
                          <i class="fas fa-trash me-1"></i> Xóa
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <% }); %>
            </div>
            <!-- Nếu không tìm thấy phòng -->
            <% } else { %>
            <div class="text-center py-5" id="noResults">
              <i class="fas fa-home fa-4x text-muted mb-3"></i>
              <h3 class="text-muted">Không tìm thấy phòng</h3>
              <p class="text-muted">Thử tìm kiếm với từ khóa khác</p>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal xác nhận xóa -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Xác nhận xóa</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p id="deleteMessage">Bạn có chắc chắn muốn xóa phòng này không?</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Hủy
            </button>

            <button type="button" id="confirmDelete" class="btn btn-danger">
              Xóa
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentRoomToDelete = null;

      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }

      function resetFilters() {
        document.getElementById("roomTypeFilter").value = "";
        document.getElementById("minPrice").value = "";
        document.getElementById("maxPrice").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("searchInput").value = "";
        filterRooms();
      }

      // Mở modal xác nhận xóa
      function showDeleteModal(roomId, roomName) {
        currentRoomToDelete = roomId;
        document.getElementById(
          "deleteMessage"
        ).textContent = `Bạn có chắc chắn muốn xóa phòng "${roomName}"? Hành động này không thể hoàn tác.`;
        const deleteModal = new bootstrap.Modal(
          document.getElementById("deleteModal")
        );
        deleteModal.show();
      }

      async function deleteRoom() {
        if (currentRoomToDelete) {
          // Gửi yêu cầu xóa đến server
          const res = await fetch(`/rooms/${currentRoomToDelete}`, {
            method: "DELETE",
          }).catch((error) => {
            console.error("Error:", error);
            alert("Có lỗi xảy ra khi xóa phòng");
          });

          const data = await res.json();

          if (data.success) {
            alert(data.message);
            location.reload();
          } else {
            alert("Xóa thất bại!");
          }
        }
      }

      // Toggle Filter Section
      document.getElementById("filterToggle").addEventListener("click", () => {
        document.getElementById("filterSection").classList.toggle("active");
      });

      // Search Functionality
      document
        .getElementById("searchInput")
        .addEventListener("input", filterRooms);

      // Filter Functionality
      document
        .getElementById("applyFilters")
        .addEventListener("click", filterRooms);
      document
        .getElementById("resetFilters")
        .addEventListener("click", resetFilters);

      // Delete Confirmation
      document
        .getElementById("confirmDelete")
        .addEventListener("click", deleteRoom);

      // Menu Navigation
      document.querySelectorAll(".nav-link").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          document
            .querySelectorAll(".nav-link")
            .forEach((l) => l.classList.remove("active"));
          link.classList.add("active");
        });
      });
    </script>
  </body>
</html>
